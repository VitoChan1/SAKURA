---
title: "Make run summary plots"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(dplyr)
require(magrittr)
require(reshape2)
require(Matrix)
require(ggExtra)
options(stringsAsFactors = FALSE)
getwd()
```

# Configuration

```{r paths}
emb_path <- './runs/EX07_01/logs'
pheno_df_path <- './dataset/10X_Purified_PBMC/pooled_pheno.csv'
expr_mat_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered.mtx'
gene_name_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_gene_names.csv'
cell_name_path <- './dataset/10X_Purified_PBMC/cleaned_pooled_log_count_dgC_unfiltered_cell_names.csv'
```

# Import Labels

```{r import labels}
pheno_df <- read.csv(pheno_df_path) %>%
  rename('cell' = 'X')
expr_mat <- readMM(expr_mat_path)
gene_names <- read.csv(gene_name_path)[, 2]
cell_names <- read.csv(cell_name_path)[, 2]
rownames(expr_mat) <- gene_names
colnames(expr_mat) <- cell_names
```

# Make Embedding Plots

```{r global configs}
total_epochs <- 100
```

## Main latent plots (main.1 and main.2)


```{r signature latent plots}
try({
      keys_to_plot <- c("overall_test_all_latent")
      output_width <- 15
      output_height <- 15
      for (i in seq(1, total_epochs, 9)) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')

          plt <- ggplot(cur_emb) +
            geom_point(aes(x = main.1, y = main.2, color = data_key)) +
            theme_classic() +
            theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)
          plt_path <- './runs/EX07_01/plots/main_lat'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_main.jpg')
          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)
        }
      }
    })
```

## Phenotype latents

```{r signature distrib}
try({
      keys_to_plot <- c("overall_test_all_latent")
      output_width <- 10
      output_height <- 10
      for (i in seq(1, total_epochs, 9)) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')
          cur_emb2 <- cur_emb %>% select(-data_key, -data_key)
          plt <- ggplot() +
            geom_density(data = cur_emb, aes(x = data_key.1, colour = data_key)) +
            geom_density(data = cur_emb2, aes(x = data_key.1), colour = "grey") +
            # facet_wrap(~data_key) +
            theme_classic() +
            theme(legend.position = 'bottom')

          plt_path <- './runs/EX07_01/plots/pheno_distrib'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_data_key.jpg')
          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)
        }
      }
    })
```

## 3-D Plots

```{r}
require(plotly)
require(htmlwidgets)
try({
      keys_to_plot <- c("overall_test_all_latent")
      for (i in seq(1, total_epochs, 9)) {
        for (cur_key in keys_to_plot[1]) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
            left_join(y = pheno_df %>% select(cell, data_key), by = 'cell')
          plt <- plot_ly(cur_emb, x = ~main.1, y = ~main.2, z = ~data_key.1, color = ~data_key)
          plt_path <- paste0(getwd(), '/runs/EX07_01/plots/3d_plt/', i, '_main.1_main.2_data_key_', cur_key)
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/plt.html')
          saveWidget(plt, file = plt_filename)
        }
      }
    })

```

# Notes

In overall test set, we observed performance drop after epoch 50, this may because of over-regularization on the extra latent space. As shown in the log excerpt, regularization loss inflated dramatically in later stages. But for epochs before 50, results shows good conformity of datasets with only log-norm, which is a good sign.

```{text}
[Extractor Controller]: next epoch, current global epoch: 100
Main latent loss-wise epochs: {'loss': {'L2': 100, 'L1': 100}, 'regularization': {'uniform_shape_unsupervised': 100}}
Main latent loss-wise weights: {'loss': {'L2': 1.0, 'L1': 1.0}, 'regularization': {'uniform_shape_unsupervised': 39.45037735389121}}
Phenotype loss-wise epochs: {'data_key': {'loss': {'NLL': 100}, 'regularization': {'shape_uniform_unsupervised': 100}}}
Phenotype loss-wise weights: {'data_key': {'loss': {'NLL': 1.0}, 'regularization': {'shape_uniform_unsupervised': 1378.0612339822376}}}
Signature loss-wise epochs: {}
Signature loss-wise weights: {}
```

Next step:

* Add a 'capping' option to regularization weight to limit the inflation speed
* Also print out train set