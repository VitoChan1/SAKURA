---
title: "Make run summary plots"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(dplyr)
require(magrittr)
require(reshape2)
options(stringsAsFactors = FALSE)
getwd()
```

# Configuration

```{r paths}
emb_path <- './runs/EX05_06/logs'
pheno_df_path <- './dataset/PUMC_mouse_cardio/TAC_cell_info_191024.csv'
expr_mat_path <- './dataset/PUMC_mouse_cardio/TAC_cell_umi_191024.csv'
expr_mat_SCT_path <- './dataset/PUMC_mouse_cardio/sctransform_poission_res.csv.gz'
```

# Import Labels

```{r import labels}
pheno_df <- read.csv(pheno_df_path)
expr_mat <- read.csv(expr_mat_path) %>% t
expr_sct_mat <- read.csv(expr_mat_SCT_path) %>% t()
colnames(expr_sct_mat) <- expr_sct_mat[1,]
expr_sct_mat <- expr_sct_mat[-1,]
```

# Make Embedding Plots

```{r global configs}
total_epochs <- 120
```

## Main latent plots (main.1 and main.2)


```{r signature latent plots}
try({
      keys_to_plot <- c("overall_test_all_latent", "overall_train_all_latent")
      output_width <- 5
      output_height <- 5
      for (i in 1:total_epochs) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
                  rename('ID' = 'X') %>%
                  left_join(y = pheno_df %>% select(ID, bigClass), by = 'ID')

          plt <- ggplot(cur_emb) +
                  geom_point(aes(x = CM.1, y = MP.1, color = bigClass)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)
          plt_path <- './runs/EX05_06/plots/signature_lat'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_CM_MP.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_point(aes(x = CM.1, y = FB.1, color = bigClass)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)

          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_CM_FB.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_point(aes(x = MP.1, y = EC.1, color = bigClass)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_MP_EC.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_point(aes(x = EC.1, y = FB.1, color = bigClass)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')
          plt <- ggMarginal(plt, groupColour = TRUE, groupFill = TRUE)
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_EC_FB.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)


        }
      }
    })
```

```{r signature distrib}
try({
      keys_to_plot <- c("overall_test_all_latent", "overall_train_all_latent")
      output_width <- 10
      output_height <- 10
      for (i in 50:total_epochs) {
        for (cur_key in keys_to_plot) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
                  rename('ID' = 'X') %>%
                  left_join(y = pheno_df %>% select(ID, bigClass, res.1, ident), by = 'ID')
          cur_emb2 <- cur_emb %>% select(-res.1, -ident)
          plt <- ggplot() +
                  geom_density(data = cur_emb, aes(x = EC.1, colour = ident)) +
                  geom_density(data = cur_emb2, aes(x = EC.1), colour = "grey") +
                  facet_wrap(~ident) +
                  theme_classic() +
                  theme(legend.position = 'bottom')

          plt_path <- './runs/EX05_06/plots/signature_distrib'
          system(paste0('mkdir -p ', plt_path))
          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_EC.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)


          plt <- ggplot() +
                  geom_density(data = cur_emb, aes(x = MP.1, colour = ident)) +
                  geom_density(data = cur_emb2, aes(x = MP.1), colour = "grey") +
                  facet_wrap(~ident) +
                  theme_classic() +
                  theme(legend.position = 'bottom')

          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_MP.jpg')
          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot() +
                  geom_density(data = cur_emb, aes(x = FB.1, colour = ident)) +
                  geom_density(data = cur_emb2, aes(x = FB.1), colour = "grey") +
                  facet_wrap(~ident) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_FB.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot() +
                  geom_density(data = cur_emb, aes(x = CM.1, colour = ident)) +
                  geom_density(data = cur_emb2, aes(x = CM.1), colour = "grey") +
                  facet_wrap(~ident) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_CM.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_density(aes(x = T.1, color = bigClass == 'T')) +
                  geom_density(aes(x = T.1)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_T.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_density(aes(x = main.1, color = bigClass)) +
                  geom_density(aes(x = main.1)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_main_1.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

          plt <- ggplot(cur_emb) +
                  geom_density(aes(x = main.2, color = bigClass)) +
                  geom_density(aes(x = main.2)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_main_2.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)
          plt <- ggplot(cur_emb) +
                  geom_density(aes(x = GN.1, color = bigClass == 'GN')) +
                  geom_density(aes(x = GN.1)) +
                  theme_classic() +
                  theme(legend.position = 'bottom')


          plt_filename <- paste0(plt_path, '/', i, '_', cur_key, '_GN.jpg')

          ggsave(plt, filename = plt_filename, width = output_width, height = output_height)

        }
      }
    })
```

```{r signature gene content}
keys_to_plot <- c("overall_test_all_latent", "overall_train_all_latent")
signatures_to_plot <- c("CM", "MP", "EC", "FB")
signature_genes <- list()
signature_genes[["CM"]] <- c("Tnnt2", "Actn2", "Myh6", "Myh7", "Tnni3")
signature_genes[["MP"]] <- c("Cd68", "Csf1r", "Cd163", "C5ar1", "Mrc1")
signature_genes[["EC"]] <- c("Cdh5", "Vwf", "Kdr", "Eng", "Pecam1")
signature_genes[["FB"]] <- c("Fn1", "Vim", "Pdgfra")
output_width <- 10
output_height <- 10
for (i in 50:50) {
  for (cur_key in keys_to_plot[2]) {
    for (cur_signature in signatures_to_plot[4]) {
      emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')

      cur_emb <- read.csv(emb_filename) %>%
              rename('ID' = 'X') %>%
              left_join(y = pheno_df %>% select(ID, bigClass, res.1, ident), by = 'ID')

      cur_expr_mat <- expr_sct_mat[cur_emb$ID, colnames(expr_sct_mat) %in% signature_genes[[cur_signature]]]
      class(cur_expr_mat) <- "numeric"

      cur_emb <- cbind(cur_emb, cur_expr_mat) %>% melt(id.vars = c("ID", paste0(cur_signature, ".1"), "bigClass"), measure.vars = signature_genes[[cur_signature]])

      plt <- ggplot(cur_emb, aes(x = FB.1, y = value, color = bigClass)) +
              geom_point() +
              facet_wrap(~variable) +
              theme_classic() +
              theme(legend.position = 'bottom')

    }
  }
}

```


## 3-D Plots

```{r}
require(plotly)
require(htmlwidgets)
try({
      keys_to_plot <- c("overall_train_all_latent", "bigClass_test_all_latent")
      for (i in 50:50) {
        for (cur_key in keys_to_plot[1]) {
          emb_filename <- paste0(emb_path, '/', i, '_', cur_key, '.csv')
          cur_emb <- read.csv(emb_filename) %>%
                  rename('ID' = 'X') %>%
                  left_join(y = pheno_df %>% select(ID, bigClass), by = 'ID')
          plt <- plot_ly(cur_emb, x = ~main.1, y = ~main.2, z = ~MP.1, color = ~bigClass)


        }
      }
    })

```
